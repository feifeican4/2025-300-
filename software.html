<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ˆ å¨ç§‘å¤«ä¸“ä¸šåˆ†æç³»ç»Ÿ v2.1</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            --secondary-gradient: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            --danger-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --success-gradient: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            --warning-gradient: linear-gradient(135deg, #f39c12 0%, #d35400 100%);
            --dark-bg: #1a1a2e;
            --card-bg: #ffffff;
            --border-color: #e1e8ed;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 30px 40px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: cover;
        }

        .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 42px;
            background: rgba(255, 255, 255, 0.2);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .logo-text h1 {
            font-size: 2.4em;
            font-weight: 700;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .logo-text p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 300;
        }

        .version-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            backdrop-filter: blur(5px);
            margin-top: 10px;
            display: inline-block;
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab {
            padding: 18px 35px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            border-right: 1px solid var(--border-color);
            white-space: nowrap;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab:hover {
            background: #edf2f7;
            color: var(--text-primary);
        }

        .tab.active {
            background: white;
            color: var(--text-primary);
            border-bottom: 3px solid #3498db;
        }

        .tab.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
        }

        .tab-content {
            padding: 0;
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .upload-section {
            padding: 50px 40px;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: var(--radius);
            padding: 70px 30px;
            margin: 30px auto;
            max-width: 700px;
            background: #f8fafc;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(52, 152, 219, 0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite linear;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .upload-area:hover {
            background: #e8f4fd;
            border-color: #2980b9;
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(52, 152, 219, 0.15);
        }

        .upload-icon {
            font-size: 80px;
            color: #3498db;
            margin-bottom: 25px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 22px;
            color: var(--text-primary);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
        }

        .control-panel {
            background: #f8fafc;
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group select,
        .form-group input {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group select:focus,
        .form-group input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .quick-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .quick-buttons button {
            flex: 1;
            padding: 10px;
            border: 2px solid #e1e8ed;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .quick-buttons button:hover {
            background: #f8f9fa;
            border-color: #3498db;
            color: #3498db;
        }

        .update-btn {
            background: var(--primary-gradient);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(26, 41, 128, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .update-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(26, 41, 128, 0.3);
        }

        .signal-controls {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.03);
        }

        .signal-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .signal-tab {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .signal-tab:hover {
            background: #e9ecef;
        }

        .signal-tab.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .signal-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            max-height: 120px;
            overflow-y: auto;
            padding: 5px;
        }

        .signal-btn {
            padding: 6px 14px;
            border: 2px solid #e1e8ed;
            border-radius: 50px;
            background: white;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .signal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .signal-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        .chart-container {
            padding: 25px;
            min-height: 850px;
            position: relative;
            background: white;
        }

        .data-preview {
            margin-top: 30px;
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-preview th,
        .data-preview td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            font-size: 13px;
        }

        .data-preview th {
            background: #f8fafc;
            position: sticky;
            top: 0;
            font-weight: 600;
            color: var(--text-primary);
        }

        .data-preview tr:hover {
            background: #f8fafc;
        }

        .loading {
            text-align: center;
            padding: 120px 20px;
            color: var(--text-secondary);
        }

        .loading h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .signal-annotation {
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            padding: 3px 10px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .signal-annotation:hover {
            transform: scale(1.05);
            z-index: 1000;
        }

        .legend {
            position: absolute;
            top: 150px;
            left: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            z-index: 10;
            font-size: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            max-width: 220px;
            backdrop-filter: blur(5px);
        }

        .legend-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
        }

        .legend-color {
            width: 18px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .error-message {
            color: #e74c3c;
            padding: 15px 20px;
            background: #ffeaea;
            border-radius: var(--radius);
            margin: 20px 0;
            display: none;
            border-left: 4px solid #e74c3c;
            font-weight: 600;
        }

        .success-message {
            color: #27ae60;
            padding: 15px 20px;
            background: #eaffea;
            border-radius: var(--radius);
            margin: 20px 0;
            display: none;
            border-left: 4px solid #27ae60;
            font-weight: 600;
        }

        .volume-distribution {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            z-index: 10;
            font-size: 11px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            max-width: 250px;
            backdrop-filter: blur(5px);
        }

        .volume-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            padding: 3px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .volume-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .volume-value {
            font-weight: 700;
            color: #3498db;
        }

        /* ç»˜å›¾å·¥å…·æ ·å¼å¢å¼º */
        .modebar {
            background: rgba(255, 255, 255, 0.95) !important;
            border-radius: 8px !important;
            border: 1px solid var(--border-color) !important;
            padding: 5px !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1) !important;
        }

        .modebar-group {
            background: transparent !important;
        }

        .modebar-btn {
            background: white !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 4px !important;
            margin: 0 2px !important;
        }

        .modebar-btn:hover {
            background: #f8fafc !important;
            border-color: #3498db !important;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .control-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }

            .logo {
                flex-direction: column;
                text-align: center;
                margin-bottom: 20px;
            }

            .header-content {
                flex-direction: column;
            }

            .control-grid {
                grid-template-columns: 1fr;
            }

            .upload-section {
                padding: 30px 20px;
            }

            .upload-area {
                padding: 40px 20px;
            }

            .legend, .volume-distribution {
                position: static;
                margin-top: 20px;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="logo-text">
                        <h1>å¨ç§‘å¤«ä¸“ä¸šåˆ†æç³»ç»Ÿ</h1>
                        <p>åŸºäºæˆäº¤é‡åˆ†å¸ƒçš„åˆæ­¥åœæ­¢ä¸é«˜æ½®äº‹ä»¶è¯†åˆ«</p>
                        <span class="version-badge">v2.1 - å¢å¼ºåˆæ­¥åœæ­¢æ£€æµ‹</span>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">ä¸“ä¸šæœºæ„çº§åˆ†æå·¥å…·</div>
                    <div style="display: flex; gap: 15px; font-size: 0.9em;">
                        <div><i class="fas fa-hand-paper"></i> åˆæ­¥åœæ­¢</div>
                        <div><i class="fas fa-fire"></i> é«˜æ½®äº‹ä»¶</div>
                        <div><i class="fas fa-brain"></i> æ™ºèƒ½åˆ†æ</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>æ•°æ®ä¸Šä¼ </span>
            </div>
            <div class="tab" onclick="switchTab('analyze')">
                <i class="fas fa-chart-bar"></i>
                <span>ä¸“ä¸šåˆ†æ</span>
            </div>
            <div class="tab" onclick="switchTab('about')">
                <i class="fas fa-info-circle"></i>
                <span>å…³äºç³»ç»Ÿ</span>
            </div>
        </div>

        <!-- ä¸Šä¼ æ•°æ®æ ‡ç­¾é¡µ -->
        <div id="upload-tab" class="tab-content active">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-file-csv"></i>
                    </div>
                    <div class="upload-text">ä¸Šä¼ CSVæ–‡ä»¶å¼€å§‹å¨ç§‘å¤«åˆ†æ</div>
                    <div class="upload-hint">
                        <strong>æ”¯æŒæ ¼å¼:</strong> CSVæ–‡ä»¶ (UTF-8ç¼–ç )<br>
                        <strong>å¿…éœ€åˆ—:</strong> è‚¡ç¥¨ä»£ç ,æ—¥æœŸ,å¼€ç›˜,æ”¶ç›˜,æœ€é«˜,æœ€ä½,æˆäº¤é‡,æˆäº¤é¢,æŒ¯å¹…,æ¶¨è·Œé¢,æ¢æ‰‹ç‡,æ¶¨è·Œå¹…<br>
                        <strong>å»ºè®®æ•°æ®:</strong> è‡³å°‘åŒ…å«100ä¸ªäº¤æ˜“æ—¥æ•°æ®ä»¥è·å¾—æœ€ä½³åˆ†æç»“æœ
                    </div>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i>
                        é€‰æ‹©CSVæ–‡ä»¶
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept=".csv" onchange="handleFileSelect(event)">
                </div>

                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>

                <div id="dataPreview" class="data-preview" style="display: none;">
                    <h3 style="padding: 15px; margin: 0; border-bottom: 1px solid var(--border-color);">æ•°æ®é¢„è§ˆ</h3>
                    <table>
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> è‚¡ç¥¨ä»£ç </th>
                                <th><i class="fas fa-calendar"></i> æ—¥æœŸ</th>
                                <th><i class="fas fa-door-open"></i> å¼€ç›˜</th>
                                <th><i class="fas fa-door-closed"></i> æ”¶ç›˜</th>
                                <th><i class="fas fa-arrow-up"></i> æœ€é«˜</th>
                                <th><i class="fas fa-arrow-down"></i> æœ€ä½</th>
                                <th><i class="fas fa-chart-bar"></i> æˆäº¤é‡</th>
                            </tr>
                        </thead>
                        <tbody id="previewTable"></tbody>
                    </table>
                </div>

                <div style="margin-top: 40px;">
                    <button class="upload-btn" onclick="startAnalysis()"
                            style="background: var(--primary-gradient);">
                        <i class="fas fa-rocket"></i>
                        å¼€å§‹å¨ç§‘å¤«åˆ†æ
                    </button>
                </div>
            </div>
        </div>

        <!-- åˆ†ææ ‡ç­¾é¡µ -->
        <div id="analyze-tab" class="tab-content">
            <div class="control-panel">
                <div class="control-grid">
                    <div class="form-group">
                        <label for="stockSelect">
                            <i class="fas fa-chart-line"></i>
                            é€‰æ‹©è‚¡ç¥¨ä»£ç 
                        </label>
                        <select id="stockSelect"></select>
                    </div>

                    <div class="form-group">
                        <label for="startDate">
                            <i class="fas fa-calendar-alt"></i>
                            å¼€å§‹æ—¥æœŸ
                        </label>
                        <input type="date" id="startDate">
                    </div>

                    <div class="form-group">
                        <label for="endDate">
                            <i class="fas fa-calendar-alt"></i>
                            ç»“æŸæ—¥æœŸ
                        </label>
                        <input type="date" id="endDate">
                    </div>

                    <div class="form-group">
                        <label>
                            <i class="fas fa-bolt"></i>
                            å¿«é€Ÿé€‰æ‹©
                        </label>
                        <div class="quick-buttons">
                            <button onclick="setDateRange(30)">1ä¸ªæœˆ</button>
                            <button onclick="setDateRange(90)">3ä¸ªæœˆ</button>
                            <button onclick="setDateRange(180)">6ä¸ªæœˆ</button>
                            <button onclick="setAllData()">å…¨éƒ¨æ•°æ®</button>
                        </div>
                    </div>

                    <button onclick="updateChart()" class="update-btn">
                        <i class="fas fa-sync-alt"></i>
                        æ›´æ–°å›¾è¡¨
                    </button>
                </div>

                <div class="signal-controls">
                    <label style="font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-filter"></i>
                        ä¿¡å·ç±»å‹ç­›é€‰:
                    </label>

                    <div class="signal-tabs" id="signalTabs">
                        <div class="signal-tab active" data-category="all">å…¨éƒ¨ä¿¡å·</div>
                        <div class="signal-tab" data-category="stop">åˆæ­¥åœæ­¢</div>
                        <div class="signal-tab" data-category="climax">é«˜æ½®äº‹ä»¶</div>
                        <div class="signal-tab" data-category="background">å¸‚åœºèƒŒæ™¯</div>
                        <div class="signal-tab" data-category="other">å…¶ä»–ä¿¡å·</div>
                    </div>

                    <div class="signal-buttons" id="signalButtons"></div>
                </div>
            </div>

            <div class="chart-container">
                <div id="chart" class="loading">
                    <i class="fas fa-chart-line" style="font-size: 60px; color: #ddd; margin-bottom: 20px;"></i>
                    <h3>ç­‰å¾…æ•°æ®åˆ†æ</h3>
                    <p>è¯·ä½¿ç”¨"æ•°æ®ä¸Šä¼ "æ ‡ç­¾é¡µä¸Šä¼ æ‚¨çš„CSVæ–‡ä»¶</p>
                </div>
            </div>

            <div id="volumeDistribution" class="volume-distribution" style="display: none;">
                <div class="legend-title">
                    <i class="fas fa-weight-hanging"></i>
                    æˆäº¤é‡åˆ†å¸ƒæŒ‡æ ‡
                </div>
                <div id="volumeMetrics"></div>
            </div>
        </div>

        <!-- å…³äºç³»ç»Ÿæ ‡ç­¾é¡µ -->
        <div id="about-tab" class="tab-content">
            <div style="padding: 40px;">
                <h2 style="margin-bottom: 30px; color: var(--text-primary); display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-info-circle"></i>
                    å¨ç§‘å¤«åˆ†æç³»ç»Ÿè¯´æ˜
                </h2>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                    <!-- åˆæ­¥åœæ­¢å¡ç‰‡ -->
                    <div style="background: white; border-radius: var(--radius); padding: 25px; border: 1px solid var(--border-color); box-shadow: var(--shadow);">
                        <h3 style="color: #3498db; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-hand-paper"></i>
                            åˆæ­¥åœæ­¢äº‹ä»¶ (PS/PSY)
                        </h3>
                        <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 15px;">
                            <strong>åˆæ­¥æ”¯æ’‘(PS):</strong> ä¸‹è·Œè¶‹åŠ¿ä¸­çš„ç¬¬ä¸€æ¬¡åœæ­¢å°è¯•ï¼Œé€šå¸¸å‡ºç°åœ¨æŠ›å”®é«˜æ½®ä¹‹å‰ã€‚æˆäº¤é‡æ”¾å¤§ï¼Œä»·æ ¼æ³¢åŠ¨å‰§çƒˆï¼Œè¡¨æ˜ä¸“ä¸šä¹°ç›˜å¼€å§‹å…¥åœºã€‚
                        </p>
                        <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 15px;">
                            <strong>åˆæ­¥ä¾›åº”(PSY):</strong> ä¸Šæ¶¨è¶‹åŠ¿ä¸­çš„ç¬¬ä¸€æ¬¡åœæ­¢å°è¯•ï¼Œé€šå¸¸å‡ºç°åœ¨ä¹°å…¥é«˜æ½®ä¹‹å‰ã€‚æˆäº¤é‡æ”¾å¤§ï¼Œè¡¨æ˜ä¸“ä¸šå–ç›˜å¼€å§‹å…¥åœºã€‚
                        </p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <strong>è¯†åˆ«è§„åˆ™:</strong>
                            <ul style="margin-top: 10px; padding-left: 20px; color: var(--text-secondary);">
                                <li>å¿…é¡»å‡ºç°åœ¨é«˜æ½®äº‹ä»¶é™„è¿‘ï¼ˆå‰å5-10ä¸ªå‘¨æœŸï¼‰</li>
                                <li>æˆäº¤é‡æ˜¾è‘—æ”¾å¤§ï¼ˆé€šå¸¸1.5å€ä»¥ä¸Šå¹³å‡é‡ï¼‰</li>
                                <li>å¸ç­¹ç»“æ„é…åˆæ­¥æ”¯æ’‘ï¼Œæ´¾å‘ç»“æ„é…åˆæ­¥ä¾›åº”</li>
                                <li>ä¸é«˜æ½®äº‹ä»¶å…±åŒæ„æˆé»‘æ¡†æ ‡æ³¨åŒºåŸŸ</li>
                            </ul>
                        </div>
                    </div>

                    <!-- é«˜æ½®äº‹ä»¶å¡ç‰‡ -->
                    <div style="background: white; border-radius: var(--radius); padding: 25px; border: 1px solid var(--border-color); box-shadow: var(--shadow);">
                        <h3 style="color: #e74c3c; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-fire"></i>
                            é«˜æ½®äº‹ä»¶ (SC/BC)
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <strong style="color: #c0392b;">æŠ›å”®é«˜æ½®(SC):</strong>
                                <p style="color: var(--text-secondary); margin-top: 5px;">ä¸‹è·Œè¶‹åŠ¿çš„æç«¯ç»ˆç»“ï¼Œæˆäº¤é‡å·¨å¤§ï¼Œé€šå¸¸æœ‰åˆæ­¥æ”¯æ’‘åœ¨å‰ã€‚</p>
                            </div>
                            <div>
                                <strong style="color: #e67e22;">ä¹°å…¥é«˜æ½®(BC):</strong>
                                <p style="color: var(--text-secondary); margin-top: 5px;">ä¸Šæ¶¨è¶‹åŠ¿çš„æç«¯ç»ˆç»“ï¼Œæˆäº¤é‡å·¨å¤§ï¼Œé€šå¸¸æœ‰åˆæ­¥ä¾›åº”åœ¨å‰ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 40px; background: var(--primary-gradient); color: white; padding: 30px; border-radius: var(--radius);">
                    <h3 style="margin-bottom: 15px;"><i class="fas fa-lightbulb"></i> ä½¿ç”¨æŒ‡å—</h3>
                    <p>1. ä¸Šä¼ CSVæ–‡ä»¶åï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ‡æ¢åˆ°åˆ†æé¡µé¢å¹¶é€‰æ‹©ç¬¬ä¸€æ”¯è‚¡ç¥¨</p>
                    <p>2. åˆæ­¥åœæ­¢å¿…é¡»ä¸é«˜æ½®äº‹ä»¶é…å¯¹å‡ºç°æ‰ä¼šè¢«è¯†åˆ«</p>
                    <p>3. å¸ç­¹ç»“æ„ä¸­å¯»æ‰¾PS+SCç»„åˆï¼Œæ´¾å‘ç»“æ„ä¸­å¯»æ‰¾PSY+BCç»„åˆ</p>
                    <p>4. é…å¯¹æˆåŠŸçš„åœæ­¢ä¸é«˜æ½®äº‹ä»¶ä¼šç”¨é»‘æ¡†ç‰¹åˆ«æ ‡æ³¨</p>
                    <p>5. ä½¿ç”¨ä¿¡å·åˆ†ç±»æ ‡ç­¾å¯ä»¥å¿«é€Ÿç­›é€‰ä¸åŒç±»å‹çš„ä¿¡å·</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let uploadedData = {};
        let stockData = {};
        let currentSignals = {};
        let activeSignalTypes = new Set();
        let signalAnnotations = {};
        let minDate = '';
        let maxDate = '';
        let volumeDistributionData = {};
        let currentSignalCategory = 'all';

        // ä¿¡å·å®šä¹‰ - é‡æ–°åˆ†ç±»
        const allSignals = {
            'stop': ['PS', 'PSY', 'åˆæ­¥æ”¯æ’‘', 'åˆæ­¥ä¾›åº”'],
            'climax': ['SC', 'BC', 'æŠ›å”®é«˜æ½®', 'ä¹°å…¥é«˜æ½®', 'AR', 'è‡ªåŠ¨åå¼¹', 'è‡ªåŠ¨å›è½'],
            'background': ['èƒŒæ™¯', 'èƒŒæ™¯-å¸ç­¹', 'èƒŒæ™¯-ç‰›å¸‚', 'èƒŒæ™¯-æ´¾å‘', 'èƒŒæ™¯-ç†Šå¸‚', 'èƒŒæ™¯-æ¨ªç›˜å¸‚åœº'],
            'other': [
                'åœæ­¢è¡Œä¸º', 'ææ…ŒæŠ›å”®', 'äºŒæ¬¡æµ‹è¯•', 'è¶…å–', 'æ­»è§’',
                'éœ‡ä»“', 'Spring', 'SOS', 'JOC', 'LPS', 'VDB',
                'SOT', 'UT', 'LPSY', 'SOW', 'VSB'
            ]
        };

        // æ‰å¹³åŒ–æ‰€æœ‰ä¿¡å·ç”¨äºå¿«é€ŸæŸ¥æ‰¾
        const allSignalsFlat = [];
        Object.values(allSignals).forEach(category => {
            category.forEach(signal => {
                if (!allSignalsFlat.includes(signal)) {
                    allSignalsFlat.push(signal);
                }
            });
        });

        // ä¿¡å·é¢œè‰²æ˜ å°„
        const signalColors = {
            // åˆæ­¥åœæ­¢
            'PS': '#3498db', 'åˆæ­¥æ”¯æ’‘': '#3498db',
            'PSY': '#e67e22', 'åˆæ­¥ä¾›åº”': '#e67e22',

            // é«˜æ½®äº‹ä»¶
            'SC': '#c0392b', 'æŠ›å”®é«˜æ½®': '#c0392b',
            'BC': '#e67e22', 'ä¹°å…¥é«˜æ½®': '#e67e22',
            'AR': '#9b59b6', 'è‡ªåŠ¨åå¼¹': '#9b59b6', 'è‡ªåŠ¨å›è½': '#9b59b6',

            // å¸‚åœºèƒŒæ™¯
            'èƒŒæ™¯-å¸ç­¹': '#27ae60', 'èƒŒæ™¯-ç‰›å¸‚': '#3498db', 'èƒŒæ™¯-æ´¾å‘': '#e74c3c',
            'èƒŒæ™¯-ç†Šå¸‚': '#f39c12', 'èƒŒæ™¯-æ¨ªç›˜å¸‚åœº': '#95a5a6',

            // å…¶ä»–ä¿¡å·
            'åœæ­¢è¡Œä¸º': '#16a085', 'ææ…ŒæŠ›å”®': '#8e44ad', 'äºŒæ¬¡æµ‹è¯•': '#9b59b6',
            'è¶…å–': '#e74c3c', 'æ­»è§’': '#9b59b6', 'éœ‡ä»“': '#3498db', 'Spring': '#2ecc71',
            'SOS': '#27ae60', 'JOC': '#16a085', 'LPS': '#2980b9', 'VDB': '#2ecc71',
            'SOT': '#e67e22', 'UT': '#d35400', 'LPSY': '#c0392b',
            'SOW': '#f39c12', 'VSB': '#e74c3c'
        };

        // èƒŒæ™¯é¢œè‰²
        const backgroundColors = {
            'å¸ç­¹': 'rgba(144, 238, 144, 0.2)',
            'ç‰›å¸‚': 'rgba(173, 216, 230, 0.2)',
            'æ´¾å‘': 'rgba(255, 182, 193, 0.2)',
            'ç†Šå¸‚': 'rgba(255, 160, 122, 0.2)',
            'æ¨ªç›˜å¸‚åœº': 'rgba(211, 211, 211, 0.2)'
        };

        // æ ‡ç­¾åˆ‡æ¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            const tabElement = document.querySelector(`.tab[onclick*="${tabName}"]`);
            if (tabElement) tabElement.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const uploadArea = document.getElementById('uploadArea');
            const originalHTML = uploadArea.innerHTML;
            uploadArea.innerHTML = `
                <div style="text-align: center;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 50px; color: #3498db; margin-bottom: 20px;"></i>
                    <div style="font-size: 18px; color: #2c3e50;">æ­£åœ¨è§£æCSVæ–‡ä»¶...</div>
                    <div style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">è¯·ç¨å€™</div>
                </div>
            `;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: 'UTF-8',
                complete: function(results) {
                    // æ¢å¤ä¸Šä¼ åŒºåŸŸ
                    uploadArea.innerHTML = originalHTML;

                    if (results.errors.length > 0) {
                        showError('CSVè§£æé”™è¯¯: ' + results.errors[0].message);
                        return;
                    }

                    const requiredColumns = ['è‚¡ç¥¨ä»£ç ', 'æ—¥æœŸ', 'å¼€ç›˜', 'æ”¶ç›˜', 'æœ€é«˜', 'æœ€ä½', 'æˆäº¤é‡', 'æˆäº¤é¢', 'æŒ¯å¹…', 'æ¶¨è·Œé¢', 'æ¢æ‰‹ç‡', 'æ¶¨è·Œå¹…'];
                    const missingColumns = requiredColumns.filter(col => !results.meta.fields.includes(col));

                    if (missingColumns.length > 0) {
                        showError(`ç¼ºå°‘å¿…éœ€åˆ—: ${missingColumns.join(', ')}`);
                        return;
                    }

                    if (results.data.length < 20) {
                        showError('æ•°æ®é‡ä¸è¶³ï¼Œè¯·æä¾›è‡³å°‘20ä¸ªäº¤æ˜“æ—¥çš„æ•°æ®');
                        return;
                    }

                    processData(results.data);
                    showSuccess(`æˆåŠŸåŠ è½½ ${results.data.length} è¡Œæ•°æ®ï¼Œå‘ç° ${Object.keys(stockData).length} æ”¯è‚¡ç¥¨`);

                    // è‡ªåŠ¨åˆ‡æ¢åˆ°åˆ†æé¡µé¢å¹¶é€‰æ‹©ç¬¬ä¸€æ”¯è‚¡ç¥¨
                    setTimeout(() => {
                        startAnalysis();
                    }, 500);
                },
                error: function(error) {
                    uploadArea.innerHTML = originalHTML;
                    showError('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
                }
            });
        }

        // å¤„ç†æ‹–æ”¾
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#2980b9';
            uploadArea.style.background = '#e8f4fd';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#3498db';
            uploadArea.style.background = '#f8fafc';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#3498db';
            uploadArea.style.background = '#f8fafc';

            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    handleFileSelect({ target: { files: [file] } });
                } else {
                    showError('è¯·ä¸Šä¼ CSVæ–‡ä»¶ï¼ˆ.csvæ ¼å¼ï¼‰');
                }
            }
        });

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorMessage.style.display = 'block';
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const successMessage = document.getElementById('successMessage');
            successMessage.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            successMessage.style.display = 'block';
        }

        // å¤„ç†æ•°æ®
        function processData(data) {
            uploadedData = data;

            // è½¬æ¢æ•°æ®ç±»å‹å¹¶æ¸…ç†
            uploadedData.forEach((row, index) => {
                row.å¼€ç›˜ = parseFloat(row.å¼€ç›˜) || 0;
                row.æ”¶ç›˜ = parseFloat(row.æ”¶ç›˜) || 0;
                row.æœ€é«˜ = parseFloat(row.æœ€é«˜) || 0;
                row.æœ€ä½ = parseFloat(row.æœ€ä½) || 0;
                row.æˆäº¤é‡ = parseFloat(row.æˆäº¤é‡) || 0;
                row.æˆäº¤é¢ = parseFloat(row.æˆäº¤é¢) || 0;
                row.æŒ¯å¹… = parseFloat(row.æŒ¯å¹…) || 0;
                row.æ¶¨è·Œå¹… = parseFloat(row.æ¶¨è·Œå¹…) || 0;
                row.æ¶¨è·Œé¢ = parseFloat(row.æ¶¨è·Œé¢) || 0;
                row.æ¢æ‰‹ç‡ = parseFloat(row.æ¢æ‰‹ç‡) || 0;

                // ç¡®ä¿æ—¥æœŸæ ¼å¼æ­£ç¡®
                if (row.æ—¥æœŸ && !row.æ—¥æœŸ.includes('-')) {
                    if (row.æ—¥æœŸ.includes('/')) {
                        const parts = row.æ—¥æœŸ.split('/');
                        if (parts.length === 3) {
                            row.æ—¥æœŸ = `${parts[0].padStart(4, '20')}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                        }
                    }
                }
            });

            // æŒ‰è‚¡ç¥¨ä»£ç åˆ†ç»„
            const stocks = {};
            const allDates = [];

            uploadedData.forEach(row => {
                const code = row.è‚¡ç¥¨ä»£ç ;
                if (!stocks[code]) {
                    stocks[code] = [];
                }
                stocks[code].push(row);
                if (row.æ—¥æœŸ) allDates.push(row.æ—¥æœŸ);
            });

            // å¯¹æ¯ä¸ªè‚¡ç¥¨çš„æ•°æ®æŒ‰æ—¥æœŸæ’åº
            stockData = {};
            Object.keys(stocks).forEach(code => {
                const stockRows = stocks[code];
                stockRows.sort((a, b) => new Date(a.æ—¥æœŸ) - new Date(b.æ—¥æœŸ));

                // è¿‡æ»¤æ— æ•ˆæ•°æ®
                const validRows = stockRows.filter(r =>
                    r.æ—¥æœŸ && r.å¼€ç›˜ && r.æ”¶ç›˜ && r.æœ€é«˜ && r.æœ€ä½ && r.æˆäº¤é‡
                );

                if (validRows.length > 0) {
                    stockData[code] = {
                        dates: validRows.map(r => r.æ—¥æœŸ),
                        open: validRows.map(r => r.å¼€ç›˜),
                        high: validRows.map(r => r.æœ€é«˜),
                        low: validRows.map(r => r.æœ€ä½),
                        close: validRows.map(r => r.æ”¶ç›˜),
                        volume: validRows.map(r => r.æˆäº¤é‡),
                        amount: validRows.map(r => r.æˆäº¤é¢),
                        change_rate: validRows.map(r => r.æ¶¨è·Œå¹…),
                        amplitude: validRows.map(r => r.æŒ¯å¹…)
                    };
                }
            });

            // è®¡ç®—æ—¥æœŸèŒƒå›´
            if (allDates.length > 0) {
                const dates = allDates.map(d => new Date(d)).sort((a, b) => a - b);
                minDate = dates[0].toISOString().split('T')[0];
                maxDate = dates[dates.length - 1].toISOString().split('T')[0];
            }

            // æ›´æ–°è‚¡ç¥¨é€‰æ‹©ä¸‹æ‹‰æ¡†
            const stockSelect = document.getElementById('stockSelect');
            stockSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è‚¡ç¥¨</option>';
            Object.keys(stockData).forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} (${stockData[code].dates.length}ä¸ªäº¤æ˜“æ—¥)`;
                stockSelect.appendChild(option);
            });

            // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€æ”¯è‚¡ç¥¨
            if (Object.keys(stockData).length > 0) {
                const firstStock = Object.keys(stockData)[0];
                stockSelect.value = firstStock;
            }

            // è®¾ç½®æ—¥æœŸæ§ä»¶
            if (minDate && maxDate) {
                const today = new Date();
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(today.getMonth() - 3);

                const endDate = maxDate ? new Date(maxDate) : today;
                let startDate = new Date(endDate);
                startDate.setMonth(startDate.getMonth() - 3);

                if (startDate < new Date(minDate)) {
                    startDate = new Date(minDate);
                }

                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                document.getElementById('startDate').min = minDate;
                document.getElementById('startDate').max = maxDate;
                document.getElementById('endDate').min = minDate;
                document.getElementById('endDate').max = maxDate;
            }

            // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
            showDataPreview();

            // åˆå§‹åŒ–ä¿¡å·é€‰æ‹©
            createSignalButtons();

            // é»˜è®¤æ¿€æ´»æ‰€æœ‰ä¿¡å·
            allSignalsFlat.forEach(signal => activeSignalTypes.add(signal));
            createSignalButtons();
        }

        // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
        function showDataPreview() {
            const preview = document.getElementById('dataPreview');
            const table = document.getElementById('previewTable');

            if (Object.keys(stockData).length === 0) {
                preview.style.display = 'none';
                return;
            }

            preview.style.display = 'block';
            table.innerHTML = '';

            // æ˜¾ç¤ºå‰10è¡Œæ•°æ®
            const firstStockCode = Object.keys(stockData)[0];
            const firstStockData = stockData[firstStockCode];

            if (!firstStockData || firstStockData.dates.length === 0) return;

            for (let i = 0; i < Math.min(10, firstStockData.dates.length); i++) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${firstStockCode}</td>
                    <td>${firstStockData.dates[i]}</td>
                    <td>${firstStockData.open[i].toFixed(2)}</td>
                    <td>${firstStockData.close[i].toFixed(2)}</td>
                    <td>${firstStockData.high[i].toFixed(2)}</td>
                    <td>${firstStockData.low[i].toFixed(2)}</td>
                    <td>${(firstStockData.volume[i] / 10000).toFixed(2)}ä¸‡</td>
                `;
                table.appendChild(row);
            }
        }

        // åˆ›å»ºä¿¡å·æŒ‰é’®ï¼ˆæŒ‰åˆ†ç±»ï¼‰
        function createSignalButtons() {
            const container = document.getElementById('signalButtons');
            container.innerHTML = '';

            // æ§åˆ¶æŒ‰é’®
            const controlButtons = [
                {text: 'å…¨é€‰', action: () => toggleAllSignals(true), icon: 'fa-check-square'},
                {text: 'å…¨ä¸é€‰', action: () => toggleAllSignals(false), icon: 'fa-square'},
                {text: 'åé€‰', action: () => toggleInverseSelection(), icon: 'fa-exchange-alt'}
            ];

            controlButtons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'signal-btn';
                button.style.background = '#f8f9fa';
                button.innerHTML = `<i class="fas ${btn.icon}"></i> ${btn.text}`;
                button.onclick = btn.action;
                container.appendChild(button);
            });

            // æ ¹æ®å½“å‰åˆ†ç±»æ˜¾ç¤ºä¿¡å·
            let signalsToShow = [];

            if (currentSignalCategory === 'all') {
                signalsToShow = allSignalsFlat;
            } else if (allSignals[currentSignalCategory]) {
                signalsToShow = allSignals[currentSignalCategory];
            }

            // å•ä¸ªä¿¡å·æŒ‰é’®
            for (const signal of signalsToShow) {
                const btn = document.createElement('button');
                btn.className = `signal-btn ${activeSignalTypes.has(signal) ? 'active' : ''}`;

                // è®¾ç½®é¢œè‰²
                if (signalColors[signal]) {
                    btn.style.borderLeft = `4px solid ${signalColors[signal]}`;
                }

                // æ·»åŠ å›¾æ ‡
                let icon = 'fa-circle';
                if (signal.includes('PS') || signal.includes('åˆæ­¥')) icon = 'fa-hand-paper';
                if (signal.includes('SC') || signal.includes('æŠ›å”®')) icon = 'fa-fire';
                if (signal.includes('BC') || signal.includes('ä¹°å…¥')) icon = 'fa-bullhorn';
                if (signal.includes('èƒŒæ™¯')) icon = 'fa-globe';
                if (signal.includes('SOS')) icon = 'fa-arrow-up';
                if (signal.includes('SOT')) icon = 'fa-arrow-down';

                btn.innerHTML = `<i class="fas ${icon}"></i> ${signal}`;
                btn.onclick = () => toggleSignal(signal);
                container.appendChild(btn);
            }
        }

        // åˆå§‹åŒ–ä¿¡å·æ ‡ç­¾åˆ‡æ¢
        function initSignalTabs() {
            const tabs = document.querySelectorAll('.signal-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // æ›´æ–°æ¿€æ´»çŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // æ›´æ–°å½“å‰åˆ†ç±»
                    currentSignalCategory = this.dataset.category;

                    // é‡æ–°åˆ›å»ºä¿¡å·æŒ‰é’®
                    createSignalButtons();
                });
            });
        }

        function toggleSignal(signal) {
            if (activeSignalTypes.has(signal)) {
                activeSignalTypes.delete(signal);
            } else {
                activeSignalTypes.add(signal);
            }
            createSignalButtons();
            if (document.getElementById('analyze-tab').classList.contains('active')) {
                updateChart();
            }
        }

        function toggleAllSignals(enable) {
            if (enable) {
                allSignalsFlat.forEach(signal => activeSignalTypes.add(signal));
            } else {
                activeSignalTypes.clear();
            }
            createSignalButtons();
            if (document.getElementById('analyze-tab').classList.contains('active')) {
                updateChart();
            }
        }

        function toggleInverseSelection() {
            allSignalsFlat.forEach(signal => {
                if (activeSignalTypes.has(signal)) {
                    activeSignalTypes.delete(signal);
                } else {
                    activeSignalTypes.add(signal);
                }
            });
            createSignalButtons();
            if (document.getElementById('analyze-tab').classList.contains('active')) {
                updateChart();
            }
        }

        // å¼€å§‹åˆ†æ
        function startAnalysis() {
            if (Object.keys(stockData).length === 0) {
                showError('è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶');
                return;
            }

            const stockSelect = document.getElementById('stockSelect');
            if (!stockSelect.value && Object.keys(stockData).length > 0) {
                // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€æ”¯è‚¡ç¥¨
                const firstStock = Object.keys(stockData)[0];
                stockSelect.value = firstStock;
            }

            switchTab('analyze');
            setTimeout(() => {
                initSignalTabs();
                updateChart();
            }, 100);
        }

        // è®¾ç½®æ—¥æœŸèŒƒå›´
        function setDateRange(days) {
            if (!maxDate) return;

            const endDate = new Date(maxDate);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - days + 1);

            if (startDate < new Date(minDate)) {
                startDate = new Date(minDate);
            }

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            updateChart();
        }

        // è®¾ç½®å…¨éƒ¨æ•°æ®
        function setAllData() {
            if (!minDate || !maxDate) return;

            document.getElementById('startDate').value = minDate;
            document.getElementById('endDate').value = maxDate;
            updateChart();
        }

        // è®¡ç®—æˆäº¤é‡åˆ†å¸ƒæŒ‡æ ‡
        function calculateVolumeDistribution(data) {
            const { close, volume, dates } = data;

            if (!close || close.length === 0) return {};

            // è®¡ç®—VWAPï¼ˆæˆäº¤é‡åŠ æƒå¹³å‡ä»·ï¼‰
            let totalVolumeValue = 0;
            let totalVolume = 0;

            for (let i = 0; i < close.length; i++) {
                const typicalPrice = (data.high[i] + data.low[i] + data.close[i]) / 3;
                totalVolumeValue += typicalPrice * volume[i];
                totalVolume += volume[i];
            }

            const vwap = totalVolume > 0 ? totalVolumeValue / totalVolume : 0;

            // è®¡ç®—POCï¼ˆæˆäº¤é‡æ§åˆ¶ç‚¹ï¼‰- ç®€åŒ–ç‰ˆæœ¬
            const priceLevels = {};
            const priceStep = (Math.max(...data.high) - Math.min(...data.low)) / 20;

            for (let i = 0; i < close.length; i++) {
                const priceLevel = Math.floor(data.close[i] / priceStep) * priceStep;
                priceLevels[priceLevel] = (priceLevels[priceLevel] || 0) + volume[i];
            }

            let pocPrice = 0;
            let maxVolume = 0;

            for (const [price, vol] of Object.entries(priceLevels)) {
                if (vol > maxVolume) {
                    maxVolume = vol;
                    pocPrice = parseFloat(price);
                }
            }

            // è®¡ç®—æˆäº¤é‡æŒ‡æ ‡
            const avgVolume = mean(volume);
            const volumeRatio = volume.length > 0 ? volume[volume.length - 1] / avgVolume : 1;

            return {
                vwap: vwap.toFixed(2),
                poc: pocPrice.toFixed(2),
                avgVolume: (avgVolume / 10000).toFixed(2) + 'ä¸‡',
                currentVolume: volume.length > 0 ? (volume[volume.length - 1] / 10000).toFixed(2) + 'ä¸‡' : '0',
                volumeRatio: volumeRatio.toFixed(2),
                highVolume: (Math.max(...volume) / 10000).toFixed(2) + 'ä¸‡',
                lowVolume: (Math.min(...volume) / 10000).toFixed(2) + 'ä¸‡'
            };
        }

        // æ˜¾ç¤ºæˆäº¤é‡åˆ†å¸ƒæŒ‡æ ‡
        function showVolumeDistribution(metrics) {
            const container = document.getElementById('volumeDistribution');
            const metricsDiv = document.getElementById('volumeMetrics');

            metricsDiv.innerHTML = `
                <div class="volume-item">
                    <span class="volume-label">VWAP:</span>
                    <span class="volume-value">${metrics.vwap}</span>
                </div>
                <div class="volume-item">
                    <span class="volume-label">POC:</span>
                    <span class="volume-value">${metrics.poc}</span>
                </div>
                <div class="volume-item">
                    <span class="volume-label">å¹³å‡æˆäº¤é‡:</span>
                    <span class="volume-value">${metrics.avgVolume}</span>
                </div>
                <div class="volume-item">
                    <span class="volume-label">å½“å‰æˆäº¤é‡:</span>
                    <span class="volume-value">${metrics.currentVolume}</span>
                </div>
                <div class="volume-item">
                    <span class="volume-label">æˆäº¤é‡æ¯”ç‡:</span>
                    <span class="volume-value">${metrics.volumeRatio}x</span>
                </div>
            `;

            container.style.display = 'block';
        }

        // å¢å¼ºçš„å¨ç§‘å¤«ä¿¡å·åˆ†æ
        function analyzeWyckoffSignals(data) {
            const signals = {};

            // åˆ†æå¸‚åœºèƒŒæ™¯
            if (activeSignalTypes.has('èƒŒæ™¯')) {
                analyzeMarketBackgrounds(data, signals);
            }

            // åˆ†æåˆæ­¥åœæ­¢äº‹ä»¶ï¼ˆé‡ç‚¹ï¼‰
            analyzePreliminaryStopEvents(data, signals);

            // åˆ†æé«˜æ½®äº‹ä»¶
            analyzeClimaxEvents(data, signals);

            // åˆ†æå…¶ä»–ä¿¡å·
            analyzeSpecificSignals(data, signals);

            // é…å¯¹åˆæ­¥åœæ­¢å’Œé«˜æ½®äº‹ä»¶ï¼Œæ·»åŠ é»‘æ¡†æ ‡æ³¨
            pairStopAndClimaxEvents(data, signals);

            return signals;
        }

        // åˆ†æåˆæ­¥åœæ­¢äº‹ä»¶
        function analyzePreliminaryStopEvents(data, signals) {
            const closes = data.close;
            const volumes = data.volume;
            const highs = data.high;
            const lows = data.low;
            const dates = data.dates;

            if (closes.length < 10) return;

            // è®¡ç®—æˆäº¤é‡ç§»åŠ¨å¹³å‡
            const volumeMA = calculateMA(volumes, 20);

            // å¯»æ‰¾åˆæ­¥æ”¯æ’‘ (PS) - å¸ç­¹ç»“æ„
            if (activeSignalTypes.has('PS') || activeSignalTypes.has('åˆæ­¥æ”¯æ’‘')) {
                for (let i = 10; i < closes.length - 5; i++) {
                    if (isPreliminarySupport(closes, volumes, highs, lows, i, volumeMA)) {
                        signals[`ps_${i}`] = {
                            type: 'PS',
                            subtype: 'åˆæ­¥æ”¯æ’‘',
                            date: dates[i],
                            index: i,
                            description: 'åˆæ­¥æ”¯æ’‘ï¼šä¸‹è·Œè¶‹åŠ¿ä¸­çš„ç¬¬ä¸€æ¬¡åœæ­¢å°è¯•ï¼Œä¸“ä¸šä¹°ç›˜å¼€å§‹å…¥åœºã€‚æˆäº¤é‡æ¯”ç‡: ' +
                                       (volumes[i] / volumeMA[i]).toFixed(2) + 'x',
                            confidence: calculateConfidenceLevel(volumes[i], volumeMA[i], 0),
                            price: closes[i],
                            volume: volumes[i],
                            matchedClimax: false
                        };
                    }
                }
            }

            // å¯»æ‰¾åˆæ­¥ä¾›åº” (PSY) - æ´¾å‘ç»“æ„
            if (activeSignalTypes.has('PSY') || activeSignalTypes.has('åˆæ­¥ä¾›åº”')) {
                for (let i = 10; i < closes.length - 5; i++) {
                    if (isPreliminarySupply(closes, volumes, highs, lows, i, volumeMA)) {
                        signals[`psy_${i}`] = {
                            type: 'PSY',
                            subtype: 'åˆæ­¥ä¾›åº”',
                            date: dates[i],
                            index: i,
                            description: 'åˆæ­¥ä¾›åº”ï¼šä¸Šæ¶¨è¶‹åŠ¿ä¸­çš„ç¬¬ä¸€æ¬¡åœæ­¢å°è¯•ï¼Œä¸“ä¸šå–ç›˜å¼€å§‹å…¥åœºã€‚æˆäº¤é‡æ¯”ç‡: ' +
                                       (volumes[i] / volumeMA[i]).toFixed(2) + 'x',
                            confidence: calculateConfidenceLevel(volumes[i], volumeMA[i], 0),
                            price: closes[i],
                            volume: volumes[i],
                            matchedClimax: false
                        };
                    }
                }
            }
        }

        // åˆæ­¥æ”¯æ’‘è¯†åˆ«å‡½æ•°
        function isPreliminarySupport(closes, volumes, highs, lows, idx, volumeMA) {
            if (idx < 5 || idx >= closes.length - 5) return false;

            // åŸºç¡€æ¡ä»¶ï¼šä»·æ ¼ä¸‹è·Œ
            const priceDown = closes[idx] < closes[idx-1];
            if (!priceDown) return false;

            // æˆäº¤é‡æ¡ä»¶ï¼šæ˜¾è‘—é«˜äºå¹³å‡å€¼
            const volumeRatio = volumes[idx] / volumeMA[idx];
            const highVolume = volumeRatio > 1.5;

            // ä»·æ ¼æ³¢åŠ¨ï¼šè¾ƒå¤§çš„ä»·æ ¼åŒºé—´
            const priceRange = highs[idx] - lows[idx];
            const avgRange = calculateAvgRange(highs, lows, idx, 10);
            const wideRange = priceRange > avgRange * 1.2;

            // å½±çº¿ç‰¹å¾ï¼šå¯èƒ½æœ‰é•¿ä¸‹å½±çº¿
            const bodySize = Math.abs(closes[idx] - closes[idx-1]);
            const lowerShadow = Math.min(closes[idx], closes[idx-1]) - lows[idx];
            const hasLongLowerShadow = lowerShadow > bodySize * 0.8;

            // è¶‹åŠ¿æ¡ä»¶ï¼šä¹‹å‰å¤„äºä¸‹è·Œè¶‹åŠ¿
            const prevTrend = isDowntrend(closes, idx, 10);

            // ç»¼åˆåˆ¤æ–­ï¼šå¸ç­¹ç»“æ„ä¸­çš„åˆæ­¥æ”¯æ’‘
            return priceDown && highVolume && (wideRange || hasLongLowerShadow) && prevTrend;
        }

        // åˆæ­¥ä¾›åº”è¯†åˆ«å‡½æ•°
        function isPreliminarySupply(closes, volumes, highs, lows, idx, volumeMA) {
            if (idx < 5 || idx >= closes.length - 5) return false;

            // åŸºç¡€æ¡ä»¶ï¼šä»·æ ¼ä¸Šæ¶¨
            const priceUp = closes[idx] > closes[idx-1];
            if (!priceUp) return false;

            // æˆäº¤é‡æ¡ä»¶ï¼šæ˜¾è‘—é«˜äºå¹³å‡å€¼
            const volumeRatio = volumes[idx] / volumeMA[idx];
            const highVolume = volumeRatio > 1.5;

            // ä»·æ ¼æ³¢åŠ¨ï¼šè¾ƒå¤§çš„ä»·æ ¼åŒºé—´
            const priceRange = highs[idx] - lows[idx];
            const avgRange = calculateAvgRange(highs, lows, idx, 10);
            const wideRange = priceRange > avgRange * 1.2;

            // å½±çº¿ç‰¹å¾ï¼šå¯èƒ½æœ‰é•¿ä¸Šå½±çº¿
            const bodySize = Math.abs(closes[idx] - closes[idx-1]);
            const upperShadow = highs[idx] - Math.max(closes[idx], closes[idx-1]);
            const hasLongUpperShadow = upperShadow > bodySize * 0.8;

            // è¶‹åŠ¿æ¡ä»¶ï¼šä¹‹å‰å¤„äºä¸Šæ¶¨è¶‹åŠ¿
            const prevTrend = isUptrend(closes, idx, 10);

            // ç»¼åˆåˆ¤æ–­ï¼šæ´¾å‘ç»“æ„ä¸­çš„åˆæ­¥ä¾›åº”
            return priceUp && highVolume && (wideRange || hasLongUpperShadow) && prevTrend;
        }

        // é«˜æ½®äº‹ä»¶åˆ†æ
        function analyzeClimaxEvents(data, signals) {
            const closes = data.close;
            const volumes = data.volume;
            const highs = data.high;
            const lows = data.low;
            const dates = data.dates;

            if (closes.length < 10) return;

            // è®¡ç®—æˆäº¤é‡ç§»åŠ¨å¹³å‡å’Œæ ‡å‡†å·®
            const volumeMA = calculateMA(volumes, 20);
            const volumeStd = calculateStd(volumes, 20);

            // è®¡ç®—ä»·æ ¼æ³¢åŠ¨ç‡
            const volatility = calculateVolatility(closes, 10);

            // å¯»æ‰¾æŠ›å”®é«˜æ½® (SC)
            if (activeSignalTypes.has('SC') || activeSignalTypes.has('æŠ›å”®é«˜æ½®')) {
                for (let i = 10; i < closes.length; i++) {
                    if (isSellingClimax(closes, volumes, highs, lows, i, volumeMA, volumeStd, volatility)) {
                        signals[`sc_${i}`] = {
                            type: 'SC',
                            subtype: 'æŠ›å”®é«˜æ½®',
                            date: dates[i],
                            index: i,
                            description: 'æŠ›å”®é«˜æ½®ï¼šä¸‹è·Œè¶‹åŠ¿çš„æç«¯ç»ˆç»“ï¼Œæˆäº¤é‡å·¨å¤§ã€‚æˆäº¤é‡æ¯”ç‡: ' +
                                       (volumes[i] / volumeMA[i]).toFixed(2) + 'x',
                            confidence: calculateConfidenceLevel(volumes[i], volumeMA[i], volatility[i]),
                            price: closes[i],
                            volume: volumes[i],
                            matchedStop: false
                        };
                    }
                }
            }

            // å¯»æ‰¾ä¹°å…¥é«˜æ½® (BC)
            if (activeSignalTypes.has('BC') || activeSignalTypes.has('ä¹°å…¥é«˜æ½®')) {
                for (let i = 10; i < closes.length; i++) {
                    if (isBuyingClimax(closes, volumes, highs, lows, i, volumeMA, volumeStd, volatility)) {
                        signals[`bc_${i}`] = {
                            type: 'BC',
                            subtype: 'ä¹°å…¥é«˜æ½®',
                            date: dates[i],
                            index: i,
                            description: 'ä¹°å…¥é«˜æ½®ï¼šä¸Šæ¶¨è¶‹åŠ¿çš„æç«¯ç»ˆç»“ï¼Œæˆäº¤é‡å·¨å¤§ã€‚æˆäº¤é‡æ¯”ç‡: ' +
                                       (volumes[i] / volumeMA[i]).toFixed(2) + 'x',
                            confidence: calculateConfidenceLevel(volumes[i], volumeMA[i], volatility[i]),
                            price: closes[i],
                            volume: volumes[i],
                            matchedStop: false
                        };
                    }
                }
            }
        }

        // æŠ›å”®é«˜æ½®è¯†åˆ«å‡½æ•°
        function isSellingClimax(closes, volumes, highs, lows, idx, volumeMA, volumeStd, volatility) {
            if (idx < 5 || idx >= closes.length - 5) return false;

            // åŸºç¡€æ¡ä»¶ï¼šä»·æ ¼ä¸‹è·Œ
            const priceDown = closes[idx] < closes[idx-1];
            if (!priceDown) return false;

            // æˆäº¤é‡æ¡ä»¶ï¼šæ˜¾è‘—é«˜äºå¹³å‡å€¼
            const volumeRatio = volumes[idx] / volumeMA[idx];
            const highVolume = volumeRatio > 2.0 || volumes[idx] > volumeMA[idx] + 2 * volumeStd[idx];

            // ä»·æ ¼æ³¢åŠ¨æ¡ä»¶
            const priceRange = highs[idx] - lows[idx];
            const avgRange = calculateAvgRange(highs, lows, idx, 10);
            const highVolatility = priceRange > avgRange * 1.5 || volatility[idx] > 0.02;

            // è¶‹åŠ¿æ¡ä»¶ï¼šä¹‹å‰å¤„äºä¸‹è·Œè¶‹åŠ¿
            const prevTrend = isDowntrend(closes, idx, 10);

            // ææ…ŒæŒ‡æ ‡ï¼šé•¿ä¸‹å½±çº¿æˆ–å¤§é˜´çº¿
            const bodySize = Math.abs(closes[idx] - closes[idx-1]);
            const lowerShadow = Math.min(closes[idx], closes[idx-1]) - lows[idx];
            const panicIndicator = lowerShadow > bodySize * 0.5 ||
                                  (closes[idx-1] - closes[idx]) / closes[idx-1] > 0.04;

            // ç»¼åˆåˆ¤æ–­
            return priceDown && highVolume && highVolatility && prevTrend && panicIndicator;
        }

        // ä¹°å…¥é«˜æ½®è¯†åˆ«å‡½æ•°
        function isBuyingClimax(closes, volumes, highs, lows, idx, volumeMA, volumeStd, volatility) {
            if (idx < 5 || idx >= closes.length - 5) return false;

            // åŸºç¡€æ¡ä»¶ï¼šä»·æ ¼ä¸Šæ¶¨
            const priceUp = closes[idx] > closes[idx-1];
            if (!priceUp) return false;

            // æˆäº¤é‡æ¡ä»¶ï¼šæ˜¾è‘—é«˜äºå¹³å‡å€¼
            const volumeRatio = volumes[idx] / volumeMA[idx];
            const highVolume = volumeRatio > 2.0 || volumes[idx] > volumeMA[idx] + 2 * volumeStd[idx];

            // ä»·æ ¼æ³¢åŠ¨æ¡ä»¶
            const priceRange = highs[idx] - lows[idx];
            const avgRange = calculateAvgRange(highs, lows, idx, 10);
            const highVolatility = priceRange > avgRange * 1.5 || volatility[idx] > 0.02;

            // è¶‹åŠ¿æ¡ä»¶ï¼šä¹‹å‰å¤„äºä¸Šæ¶¨è¶‹åŠ¿
            const prevTrend = isUptrend(closes, idx, 10);

            // ç‹‚çƒ­æŒ‡æ ‡ï¼šé•¿ä¸Šå½±çº¿æˆ–å¤§é˜³çº¿
            const bodySize = Math.abs(closes[idx] - closes[idx-1]);
            const upperShadow = highs[idx] - Math.max(closes[idx], closes[idx-1]);
            const frenzyIndicator = upperShadow > bodySize * 0.5 ||
                                   (closes[idx] - closes[idx-1]) / closes[idx-1] > 0.04;

            // ç»¼åˆåˆ¤æ–­
            return priceUp && highVolume && highVolatility && prevTrend && frenzyIndicator;
        }

        // é…å¯¹åˆæ­¥åœæ­¢å’Œé«˜æ½®äº‹ä»¶
        function pairStopAndClimaxEvents(data, signals) {
            const signalArray = Object.values(signals);

            // æŸ¥æ‰¾æ‰€æœ‰åˆæ­¥åœæ­¢ä¿¡å·
            const stopSignals = signalArray.filter(s =>
                (s.type === 'PS' || s.type === 'PSY') && !s.matchedClimax
            );

            // æŸ¥æ‰¾æ‰€æœ‰é«˜æ½®ä¿¡å·
            const climaxSignals = signalArray.filter(s =>
                (s.type === 'SC' || s.type === 'BC') && !s.matchedStop
            );

            // é…å¯¹é€»è¾‘ï¼šåˆæ­¥åœæ­¢å¿…é¡»åœ¨é«˜æ½®é™„è¿‘ï¼ˆå‰å5-10ä¸ªå‘¨æœŸå†…ï¼‰
            for (const stopSignal of stopSignals) {
                for (const climaxSignal of climaxSignals) {
                    const indexDiff = Math.abs(stopSignal.index - climaxSignal.index);

                    // æ£€æŸ¥æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…ä¸”ç±»å‹åŒ¹é…
                    if (indexDiff <= 10 && indexDiff >= 1) {
                        // å¸ç­¹ç»“æ„ï¼šPS + SC
                        if (stopSignal.type === 'PS' && climaxSignal.type === 'SC') {
                            stopSignal.matchedClimax = true;
                            climaxSignal.matchedStop = true;

                            // åˆ›å»ºé…å¯¹ä¿¡å·
                            const pairId = `pair_${stopSignal.index}_${climaxSignal.index}`;
                            signals[pairId] = {
                                type: 'PAIR',
                                subtype: 'å¸ç­¹ç»“æ„',
                                stopSignal: stopSignal,
                                climaxSignal: climaxSignal,
                                date: climaxSignal.date,
                                index: climaxSignal.index,
                                description: `å¸ç­¹ç»“æ„ï¼šåˆæ­¥æ”¯æ’‘(PS) + æŠ›å”®é«˜æ½®(SC)ï¼Œè·ç¦»${indexDiff}ä¸ªå‘¨æœŸ`,
                                start_index: Math.min(stopSignal.index, climaxSignal.index),
                                end_index: Math.max(stopSignal.index, climaxSignal.index)
                            };
                        }
                        // æ´¾å‘ç»“æ„ï¼šPSY + BC
                        else if (stopSignal.type === 'PSY' && climaxSignal.type === 'BC') {
                            stopSignal.matchedClimax = true;
                            climaxSignal.matchedStop = true;

                            // åˆ›å»ºé…å¯¹ä¿¡å·
                            const pairId = `pair_${stopSignal.index}_${climaxSignal.index}`;
                            signals[pairId] = {
                                type: 'PAIR',
                                subtype: 'æ´¾å‘ç»“æ„',
                                stopSignal: stopSignal,
                                climaxSignal: climaxSignal,
                                date: climaxSignal.date,
                                index: climaxSignal.index,
                                description: `æ´¾å‘ç»“æ„ï¼šåˆæ­¥ä¾›åº”(PSY) + ä¹°å…¥é«˜æ½®(BC)ï¼Œè·ç¦»${indexDiff}ä¸ªå‘¨æœŸ`,
                                start_index: Math.min(stopSignal.index, climaxSignal.index),
                                end_index: Math.max(stopSignal.index, climaxSignal.index)
                            };
                        }
                    }
                }
            }
        }

        // è¾…åŠ©å‡½æ•°
        function calculateMA(data, period) {
            const ma = new Array(data.length).fill(0);
            for (let i = period - 1; i < data.length; i++) {
                const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                ma[i] = sum / period;
            }
            return ma;
        }

        function calculateStd(data, period) {
            const std = new Array(data.length).fill(0);
            for (let i = period - 1; i < data.length; i++) {
                const slice = data.slice(i - period + 1, i + 1);
                const mean = slice.reduce((a, b) => a + b, 0) / period;
                const variance = slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period;
                std[i] = Math.sqrt(variance);
            }
            return std;
        }

        function calculateVolatility(prices, period) {
            const volatility = new Array(prices.length).fill(0);
            for (let i = period; i < prices.length; i++) {
                const returns = [];
                for (let j = 0; j < period; j++) {
                    if (prices[i - j - 1] > 0) {
                        returns.push(Math.log(prices[i - j] / prices[i - j - 1]));
                    }
                }
                if (returns.length > 0) {
                    const meanReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
                    const variance = returns.reduce((a, b) => a + Math.pow(b - meanReturn, 2), 0) / returns.length;
                    volatility[i] = Math.sqrt(variance);
                }
            }
            return volatility;
        }

        function calculateAvgRange(highs, lows, idx, period) {
            let sum = 0;
            let count = 0;
            for (let i = Math.max(0, idx - period + 1); i <= idx; i++) {
                sum += highs[i] - lows[i];
                count++;
            }
            return count > 0 ? sum / count : 0;
        }

        function isDowntrend(prices, idx, lookback) {
            if (idx < lookback) return false;
            return prices[idx] < prices[idx - lookback];
        }

        function isUptrend(prices, idx, lookback) {
            if (idx < lookback) return false;
            return prices[idx] > prices[idx - lookback];
        }

        function calculateConfidenceLevel(volume, avgVolume, volatility) {
            const volumeRatio = volume / avgVolume;
            let confidence = 'ä½';

            if (volumeRatio > 3 && volatility > 0.03) confidence = 'æé«˜';
            else if (volumeRatio > 2.5 && volatility > 0.02) confidence = 'é«˜';
            else if (volumeRatio > 2 && volatility > 0.015) confidence = 'ä¸­ç­‰';
            else if (volumeRatio > 1.5) confidence = 'ä½';

            return confidence;
        }

        // åŸæœ‰çš„å¸‚åœºèƒŒæ™¯å’Œå…¶ä»–ä¿¡å·åˆ†æå‡½æ•°
        function analyzeMarketBackgrounds(data, signals) {
            const closes = data.close;
            const volumes = data.volume;
            const highs = data.high;
            const lows = data.low;
            const dates = data.dates;

            if (closes.length < 20) return;

            const windowSize = 20;
            let lastBackground = null;
            let backgroundStart = dates[windowSize];

            for (let i = windowSize; i < closes.length; i += 10) {
                const startIdx = i - windowSize;
                const endIdx = i;

                const windowCloses = closes.slice(startIdx, endIdx);
                const windowHighs = highs.slice(startIdx, endIdx);
                const windowLows = lows.slice(startIdx, endIdx);

                const priceChange = (windowCloses[windowCloses.length-1] - windowCloses[0]) / windowCloses[0] * 100;
                const volatility = (Math.max(...windowHighs) - Math.min(...windowLows)) / mean(windowCloses) * 100;

                let background = 'æ¨ªç›˜å¸‚åœº';

                if (priceChange > 8 && volatility > 10) {
                    background = 'ç‰›å¸‚';
                } else if (priceChange < -8) {
                    background = 'ç†Šå¸‚';
                } else if (priceChange > -15 && priceChange < 8 && volatility > 10) {
                    background = 'å¸ç­¹';
                } else if (priceChange > -5 && priceChange < 12 && volatility > 8) {
                    background = 'æ´¾å‘';
                }

                if (background !== lastBackground) {
                    if (lastBackground) {
                        signals[`background_${i}`] = {
                            type: 'èƒŒæ™¯',
                            subtype: lastBackground,
                            date: dates[i],
                            index: i,
                            description: getBackgroundDescription(lastBackground),
                            start_date: backgroundStart,
                            end_date: dates[i]
                        };
                    }
                    lastBackground = background;
                    backgroundStart = dates[i];
                }
            }
        }

        function getBackgroundDescription(background) {
            const descriptions = {
                'å¸ç­¹': 'éœ‡è¡åŒº->ç†Šå¸‚->å¸ç­¹ï¼Œä¾›åº”åˆ°åœæ­¢è¡Œä¸ºæ‰å‡å¼±ï¼Œéœ€æ±‚å¼€å§‹å…¥åœº',
                'ç‰›å¸‚': 'éœ€æ±‚ä¸»å¯¼ï¼Œä»·æ ¼ä¸Šæ¶¨ï¼ŒSOSå›æµ‹ï¼ŒJOCå›æµ‹',
                'æ´¾å‘': 'éœ€æ±‚å‡å¼±ï¼Œä¾›åº”æ‰©å¤§ï¼ŒSOTï¼Œä¸Šå†²å›è½',
                'ç†Šå¸‚': 'ä¾›åº”ä¸»å¯¼ï¼Œä»·æ ¼ä¸‹è·Œï¼Œææ…ŒæŠ›å”®ï¼ŒäºŒæ¬¡æµ‹è¯•',
                'æ¨ªç›˜å¸‚åœº': 'ä¾›éœ€å¹³è¡¡ï¼Œæ— æ˜æ˜¾è¶‹åŠ¿'
            };
            return descriptions[background] || '';
        }

        function analyzeSpecificSignals(data, signals) {
            // å…¶ä»–ä¿¡å·åˆ†æé€»è¾‘ï¼ˆä¿æŒåŸæœ‰ï¼‰
            // è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–ä¿¡å·çš„è¯†åˆ«é€»è¾‘
        }

        function mean(arr) {
            if (!arr || arr.length === 0) return 0;
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        // åˆ›å»ºå›¾æ³¨
        function createLegend() {
            const existingLegend = document.querySelector('.legend');
            if (existingLegend) existingLegend.remove();

            const legend = document.createElement('div');
            legend.className = 'legend';
            legend.innerHTML = `
                <div class="legend-title">
                    <i class="fas fa-map"></i>
                    å¨ç§‘å¤«ä¿¡å·å›¾æ³¨
                </div>
            `;

            // åˆæ­¥åœæ­¢
            const stopSignals = [
                {name: 'åˆæ­¥æ”¯æ’‘ (PS)', color: '#3498db'},
                {name: 'åˆæ­¥ä¾›åº” (PSY)', color: '#e67e22'}
            ];

            stopSignals.forEach(signal => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${signal.color}"></div>
                    <span>${signal.name}</span>
                `;
                legend.appendChild(item);
            });

            // é«˜æ½®äº‹ä»¶
            legend.innerHTML += `<div style="margin-top: 10px; font-weight: 600; color: var(--text-primary);">é«˜æ½®äº‹ä»¶</div>`;

            const climaxSignals = [
                {name: 'æŠ›å”®é«˜æ½® (SC)', color: '#c0392b'},
                {name: 'ä¹°å…¥é«˜æ½® (BC)', color: '#e67e22'}
            ];

            climaxSignals.forEach(signal => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${signal.color}"></div>
                    <span>${signal.name}</span>
                `;
                legend.appendChild(item);
            });

            // é»‘æ¡†æ ‡æ³¨
            legend.innerHTML += `<div style="margin-top: 10px; font-weight: 600; color: var(--text-primary);">ç»“æ„æ ‡æ³¨</div>`;

            const pairSignal = {
                name: 'PS+SC / PSY+BC é…å¯¹',
                color: '#2c3e50',
                style: 'border: 2px solid #2c3e50; background: rgba(44, 62, 80, 0.1);'
            };

            const item = document.createElement('div');
            item.className = 'legend-item';
            item.innerHTML = `
                <div class="legend-color" style="${pairSignal.style}"></div>
                <span>${pairSignal.name}</span>
            `;
            legend.appendChild(item);

            const chartDiv = document.getElementById('chart');
            chartDiv.appendChild(legend);

            return legend;
        }

        // æ›´æ–°å›¾è¡¨
        function updateChart() {
            const stockSelect = document.getElementById('stockSelect');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const stockCode = stockSelect.value;

            if (!stockCode || !stockData[stockCode]) {
                document.getElementById('chart').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle" style="font-size: 50px; color: #f39c12; margin-bottom: 20px;"></i>
                        <h3>è¯·å…ˆé€‰æ‹©è‚¡ç¥¨</h3>
                        <p>ä»ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©è¦åˆ†æçš„è‚¡ç¥¨ä»£ç </p>
                    </div>
                `;
                return;
            }

            const stock = stockData[stockCode];

            // è¿‡æ»¤æ•°æ®
            const filteredData = {
                dates: [], open: [], high: [], low: [], close: [], volume: []
            };

            for (let i = 0; i < stock.dates.length; i++) {
                const currentDate = stock.dates[i];
                if (currentDate >= startDate && currentDate <= endDate) {
                    filteredData.dates.push(stock.dates[i]);
                    filteredData.open.push(stock.open[i]);
                    filteredData.high.push(stock.high[i]);
                    filteredData.low.push(stock.low[i]);
                    filteredData.close.push(stock.close[i]);
                    filteredData.volume.push(stock.volume[i]);
                }
            }

            if (filteredData.dates.length === 0) {
                document.getElementById('chart').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-search" style="font-size: 50px; color: #95a5a6; margin-bottom: 20px;"></i>
                        <h3>æ— æ•°æ®</h3>
                        <p>è¯·è°ƒæ•´æ—¶é—´èŒƒå›´æˆ–é€‰æ‹©å…¶ä»–è‚¡ç¥¨</p>
                    </div>
                `;
                return;
            }

            // åˆ†æä¿¡å·
            currentSignals = analyzeWyckoffSignals(filteredData);

            // è®¡ç®—æˆäº¤é‡åˆ†å¸ƒæŒ‡æ ‡
            volumeDistributionData = calculateVolumeDistribution(filteredData);
            showVolumeDistribution(volumeDistributionData);

            // åˆ›å»ºå›¾è¡¨
            createChart(stockCode, filteredData, currentSignals);
        }

        // åˆ›å»ºä¸“ä¸šKçº¿å›¾
        function createChart(stockCode, data, signals) {
            const chartDiv = document.getElementById('chart');
            chartDiv.innerHTML = '';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            chartDiv.innerHTML = `
                <div style="text-align: center; padding: 100px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #3498db; margin-bottom: 20px;"></i>
                    <div style="font-size: 18px; color: #2c3e50;">æ­£åœ¨ç”Ÿæˆå¨ç§‘å¤«åˆ†æå›¾è¡¨...</div>
                </div>
            `;

            setTimeout(() => {
                // åˆ›å»ºå­å›¾
                const figure = {
                    data: [],
                    layout: {
                        grid: {rows: 2, columns: 1, pattern: 'independent', rowheight: [0.7, 0.3]},
                        title: {
                            text: `ğŸ“ˆ ${stockCode} - å¨ç§‘å¤«ä¸“ä¸šåˆ†æ`,
                            font: {size: 22, color: '#2c3e50', family: 'Arial, sans-serif'},
                            x: 0.05,
                            xanchor: 'left'
                        },
                        xaxis: {
                            title: {text: 'æ—¥æœŸ', font: {size: 14}},
                            type: 'date',
                            gridcolor: '#f0f0f0',
                            rangeslider: {visible: false},
                            showgrid: true,
                            tickformat: '%Y-%m-%d',
                            showline: true,
                            linecolor: '#e0e0e0'
                        },
                        xaxis2: {
                            title: {text: 'æ—¥æœŸ', font: {size: 14}},
                            type: 'date',
                            gridcolor: '#f0f0f0',
                            showgrid: true,
                            showline: true,
                            linecolor: '#e0e0e0'
                        },
                        yaxis: {
                            title: {text: 'ä»·æ ¼ (å…ƒ)', font: {size: 14}},
                            gridcolor: '#f0f0f0',
                            tickformat: '.2f',
                            showgrid: true,
                            zeroline: false,
                            showline: true,
                            linecolor: '#e0e0e0'
                        },
                        yaxis2: {
                            title: {text: 'æˆäº¤é‡', font: {size: 14}},
                            gridcolor: '#f0f0f0',
                            showgrid: true,
                            zeroline: false,
                            showline: true,
                            linecolor: '#e0e0e0'
                        },
                        plot_bgcolor: 'white',
                        paper_bgcolor: 'white',
                        margin: {l: 80, r: 80, t: 100, b: 80},
                        showlegend: false,
                        hovermode: 'x unified',
                        height: 850,
                        annotations: [],
                        shapes: [],
                        hoverlabel: {
                            bgcolor: 'white',
                            font: {size: 12},
                            bordercolor: '#3498db'
                        }
                    },
                    config: {
                        responsive: true,
                        displayModeBar: true,
                        displaylogo: false,
                        modeBarButtonsToAdd: [
                            {
                                name: 'drawline',
                                title: 'ç»˜åˆ¶è¶‹åŠ¿çº¿',
                                icon: Plotly.Icons.drawline,
                                click: function(gd) {
                                    Plotly.relayout(gd, {
                                        'dragmode': 'drawline'
                                    });
                                }
                            },
                            {
                                name: 'drawopenpath',
                                title: 'ç»˜åˆ¶è‡ªç”±è·¯å¾„',
                                icon: Plotly.Icons.drawopenpath,
                                click: function(gd) {
                                    Plotly.relayout(gd, {
                                        'dragmode': 'drawopenpath'
                                    });
                                }
                            },
                            {
                                name: 'eraseshape',
                                title: 'æ“¦é™¤å›¾å½¢',
                                icon: Plotly.Icons.eraseshape,
                                click: function(gd) {
                                    Plotly.relayout(gd, {
                                        'dragmode': 'eraseshape'
                                    });
                                }
                            }
                        ],
                        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                        scrollZoom: true
                    }
                };

                // æ·»åŠ Kçº¿å›¾
                figure.data.push({
                    type: 'candlestick',
                    x: data.dates,
                    open: data.open,
                    high: data.high,
                    low: data.low,
                    close: data.close,
                    xaxis: 'x',
                    yaxis: 'y',
                    name: 'Kçº¿',
                    increasing: {
                        line: {color: '#e74c3c', width: 1},
                        fillcolor: '#e74c3c'
                    },
                    decreasing: {
                        line: {color: '#27ae60', width: 1},
                        fillcolor: '#27ae60'
                    },
                    hoverinfo: 'all',
                    hoverlabel: {
                        bgcolor: 'white',
                        font: {size: 12}
                    }
                });

                // æ·»åŠ æˆäº¤é‡å›¾
                const volumeColors = data.close.map((close, i) =>
                    close >= data.open[i] ? '#e74c3c' : '#27ae60'
                );

                figure.data.push({
                    type: 'bar',
                    x: data.dates,
                    y: data.volume,
                    xaxis: 'x2',
                    yaxis: 'y2',
                    name: 'æˆäº¤é‡',
                    marker: {color: volumeColors},
                    opacity: 0.7,
                    hoverinfo: 'x+y',
                    hovertemplate: 'æˆäº¤é‡: %{y:.0f}<extra></extra>'
                });

                // å¤„ç†èƒŒæ™¯åŒºåŸŸ
                const backgroundSignals = Object.values(signals).filter(s => s.type === 'èƒŒæ™¯');
                for (let i = 0; i < backgroundSignals.length; i++) {
                    const signal = backgroundSignals[i];
                    if (activeSignalTypes.has('èƒŒæ™¯')) {
                        const nextSignal = backgroundSignals[i + 1];
                        const endDate = nextSignal ? nextSignal.date : data.dates[data.dates.length - 1];

                        figure.layout.shapes.push({
                            type: 'rect',
                            xref: 'x',
                            yref: 'paper',
                            x0: signal.start_date,
                            x1: endDate,
                            y0: 0,
                            y1: 1,
                            fillcolor: backgroundColors[signal.subtype],
                            opacity: 0.2,
                            layer: 'below',
                            line: {width: 0},
                            name: signal.subtype
                        });
                    }
                }

                // æ·»åŠ é»‘æ¡†æ ‡æ³¨ï¼ˆé…å¯¹ä¿¡å·ï¼‰
                const pairSignals = Object.values(signals).filter(s => s.type === 'PAIR');
                pairSignals.forEach(pair => {
                    if (pair.start_index !== undefined && pair.end_index !== undefined) {
                        const startDate = data.dates[pair.start_index];
                        const endDate = data.dates[pair.end_index];
                        const minPrice = Math.min(...data.low.slice(pair.start_index, pair.end_index + 1));
                        const maxPrice = Math.max(...data.high.slice(pair.start_index, pair.end_index + 1));

                        // æ·»åŠ é»‘æ¡†
                        figure.layout.shapes.push({
                            type: 'rect',
                            xref: 'x',
                            yref: 'y',
                            x0: startDate,
                            x1: endDate,
                            y0: minPrice * 0.98,
                            y1: maxPrice * 1.02,
                            fillcolor: 'rgba(44, 62, 80, 0.1)',
                            line: {
                                color: '#2c3e50',
                                width: 2,
                                dash: 'solid'
                            },
                            layer: 'above',
                            name: pair.subtype
                        });

                        // æ·»åŠ æ ‡æ³¨æ–‡å­—
                        figure.layout.annotations.push({
                            x: endDate,
                            y: maxPrice * 1.03,
                            xref: 'x',
                            yref: 'y',
                            text: pair.subtype,
                            showarrow: false,
                            font: {
                                size: 12,
                                color: '#2c3e50',
                                weight: 'bold'
                            },
                            bgcolor: 'rgba(255, 255, 255, 0.8)',
                            bordercolor: '#2c3e50',
                            borderwidth: 1,
                            borderpad: 4,
                            hovertext: pair.description
                        });
                    }
                });

                // æ·»åŠ ä¿¡å·æ ‡æ³¨
                signalAnnotations = {};
                Object.values(signals).forEach(signal => {
                    if (signal.type !== 'èƒŒæ™¯' && signal.type !== 'PAIR' && activeSignalTypes.has(signal.type)) {
                        // ç¡®å®šYè½´ä½ç½®
                        let yPosition;
                        if (signal.type === 'PS' || signal.type === 'SC' || signal.subtype === 'åˆæ­¥æ”¯æ’‘' || signal.subtype === 'æŠ›å”®é«˜æ½®') {
                            yPosition = data.low[signal.index] * 0.97;
                        } else if (signal.type === 'PSY' || signal.type === 'BC' || signal.subtype === 'åˆæ­¥ä¾›åº”' || signal.subtype === 'ä¹°å…¥é«˜æ½®') {
                            yPosition = data.high[signal.index] * 1.03;
                        } else {
                            yPosition = data.high[signal.index] * 1.02;
                        }

                        const annotation = {
                            x: signal.date,
                            y: yPosition,
                            xref: 'x',
                            yref: 'y',
                            text: signal.subtype || signal.type,
                            showarrow: true,
                            arrowhead: 2,
                            arrowsize: 1,
                            arrowwidth: 2,
                            arrowcolor: signalColors[signal.type] || signalColors[signal.subtype] || '#3498db',
                            bgcolor: 'white',
                            bordercolor: signalColors[signal.type] || signalColors[signal.subtype] || '#3498db',
                            borderwidth: 2,
                            borderpad: 4,
                            font: {color: signalColors[signal.type] || signalColors[signal.subtype] || '#3498db', size: 11, weight: 'bold'},
                            hovertext: signal.description,
                            hoverlabel: {
                                bgcolor: 'white',
                                font: {size: 12}
                            },
                            captureevents: true
                        };
                        figure.layout.annotations.push(annotation);
                        signalAnnotations[signal.type + '_' + signal.index] = signal;
                    }
                });

                // é…ç½®è”åŠ¨
                figure.layout.xaxis2 = {...figure.layout.xaxis2, matches: 'x'};

                // ç»˜å›¾
                Plotly.newPlot(chartDiv, figure.data, figure.layout, figure.config).then(function() {
                    // æ·»åŠ å›¾æ³¨
                    createLegend();

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    chartDiv.on('plotly_click', function(data) {
                        if (data.points && data.points[0]) {
                            const point = data.points[0];
                            const signalKey = Object.keys(signalAnnotations).find(key =>
                                Math.abs(new Date(signalAnnotations[key].date) - new Date(point.x)) < 86400000 // 1å¤©å†…çš„è¯¯å·®
                            );
                            if (signalKey) {
                                showSignalDetails(signalAnnotations[signalKey]);
                            }
                        }
                    });
                });
            }, 100);
        }

        // æ˜¾ç¤ºä¿¡å·è¯¦æƒ…
        function showSignalDetails(signal) {
            const details = `
                <div style="text-align: left;">
                    <h3 style="color: ${signalColors[signal.type] || signalColors[signal.subtype] || '#3498db'}; margin-bottom: 10px;">
                        ${signal.subtype || signal.type}
                    </h3>
                    <p><strong>å‘ç”Ÿæ—¶é—´:</strong> ${signal.date}</p>
                    <p><strong>ä»·æ ¼:</strong> ${signal.price ? signal.price.toFixed(2) : 'N/A'}</p>
                    ${signal.volume ? `<p><strong>æˆäº¤é‡:</strong> ${(signal.volume / 10000).toFixed(2)}ä¸‡</p>` : ''}
                    ${signal.confidence ? `<p><strong>ç½®ä¿¡åº¦:</strong> ${signal.confidence}</p>` : ''}
                    <p style="margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        ${signal.description}
                    </p>
                </div>
            `;

            alert(`${signal.subtype || signal.type}\nå‘ç”Ÿæ—¶é—´: ${signal.date}\n${signal.description}`);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæœ€è¿‘3ä¸ªæœˆ
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];

            // é»˜è®¤æ¿€æ´»æ‰€æœ‰ä¿¡å·
            allSignalsFlat.forEach(signal => activeSignalTypes.add(signal));

            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'u') {
                    document.getElementById('fileInput').click();
                }
                if (e.ctrlKey && e.key === 'Enter') {
                    updateChart();
                }
            });
        });
    </script>
</body>
</html>